<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="logo.jpeg">
</head>
<body>
    <div class="sidebar">
        <h2>Menu</h2>
        <ul>
            <li><a href="#dashboard">Tableau de bord</a></li>
            <li><a href="#datosFinance">Données financières</a></li>
            <li><a href="#report">Graphique de dépenses</a></li>
            <li><a href="#settings">Paramètres</a></li>
        </ul>
    </div>
    <div class="content">
        <header>
            <h1>FinanceFlow</h1>
        </header>
        <br><br><br>

        <h2>Tableau de bord</h2>
        <div class="dashboard">
            <div class="card">
                <h3>Revenus totaux</h3>
                <p id="total-income">0 €</p>
            </div>
            <div class="card">
                <h3>Dépenses totales</h3>
                <p id="total-expenses">0 €</p>
            </div>
            <div class="card">
                <h3>Solde</h3>
                <p id="balance">0 €</p>
            </div>
        </div>

        <!-- Sélecteur de vue -->
        <div id="view-selector">
            <button id="view-category">Vue par Catégorie</button>
            <button id="view-type">Vue par Type</button>
        </div>
        <section id="datosFinance">
            <h2>Données financières</h2>
            <table>
                <thead>
                    <tr>
                        <th>Catégorie</th>
                        <th>Type</th>
                        <th>Montant (€)</th>
                    </tr>
                </thead>
                <tbody id="data-table">
                    <!-- Les données seront ajoutées dynamiquement ici -->
                </tbody>
            </table>
        </section>
        <br><br><br><br>
        
        <div class="forms">
            <form id="data-form">
                <h3>Ajouter une transaction</h3>
                <label for="category">Catégorie :</label>
                <select id="category" required>
                    <option value="salaire">Salaire</option>
                    <option value="loyer">Loyer</option>
                    <option value="alimentation">Alimentation</option>
                    <option value="transport">Transport</option>
                    <option value="loisirs">Loisirs</option>
                    <option value="autres">Autres</option>
                </select>

                <label for="type">Type :</label>
                <select id="type">
                    <option value="income">Revenu</option>
                    <option value="expense">Dépense</option>
                </select>
                <label for="amount">Montant (€) :</label>
                <input type="number" id="amount" required>
                <br><br>
                <button type="submit">Ajouter</button>
            </form>
        </div>
        <br><br><br><br><br><br>
        <section id="report">
            <!-- Canvas pour le graphique -->
            <canvas id="expenseChart" width="400" height="200"></canvas>
        </section>
        
    </div>

    <script src="script.js"></script>
    <script type="module">
        // Importer les fonctions dont vous avez besoin depuis les SDKs Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
      
        // Configuration de votre application Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAe6LE6UDDnSS-CkTCb78KyzCdpKwF1xf8",
          authDomain: "finance-flow-2025.firebaseapp.com",
          projectId: "finance-flow-2025",
          storageBucket: "finance-flow-2025.firebasestorage.app",
          messagingSenderId: "197193077601",
          appId: "1:197193077601:web:c7544bcaf041b713f82b20",
          measurementId: "G-HDQ3RJE86D"
        };
      
        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
      
        // Initialiser Firestore
        const db = getFirestore(app);
      
        // Référence à la collection "transactions" de Firestore
        const transactionsCollection = collection(db, "transactions");
      
        // Ajouter une transaction dans Firestore
        async function addTransaction(category, type, amount) {
          try {
            const docRef = await addDoc(transactionsCollection, {
              category: category,
              type: type,
              amount: amount,
              timestamp: new Date()
            });
            console.log("Transaction ajoutée avec succès: ", docRef.id);
            updateDashboard();  // Mettre à jour le tableau de bord après ajout
            updateTable();  // Mettre à jour la table après ajout
          } catch (e) {
            console.error("Erreur lors de l'ajout de la transaction: ", e);
          }
        }
      
        // Récupérer toutes les transactions de Firestore
        async function getTransactions() {
          const querySnapshot = await getDocs(transactionsCollection);
          const transactionsList = querySnapshot.docs.map(doc => doc.data());
          return transactionsList;
        }
      
        // Fonction pour mettre à jour le tableau avec les transactions récupérées
        async function updateTable() {
          const transactionsList = await getTransactions();
          const tableBody = document.getElementById("data-table");
          tableBody.innerHTML = transactionsList
            .map(t => `
            <tr>
                <td>${t.category}</td>
                <td>${t.type === "income" ? "Revenu" : "Dépense"}</td>
                <td>${t.amount} €</td>
            </tr>
            `)
            .join("");
        }
      
        // Fonction pour mettre à jour le tableau de bord (revenus, dépenses, solde)
        async function updateDashboard() {
          const transactionsList = await getTransactions();
          const totalIncome = transactionsList.filter(t => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
          const totalExpenses = transactionsList.filter(t => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
          const balance = totalIncome - totalExpenses;
      
          document.getElementById("total-income").textContent = `${totalIncome} €`;
          document.getElementById("total-expenses").textContent = `${totalExpenses} €`;
          document.getElementById("balance").textContent = `${balance} €`;
      
          // Mettre à jour le graphique
          updateChart('category');  // Par défaut, afficher par catégorie
        }
      
        // Fonction pour mettre à jour le graphique en fonction de la vue
        async function updateChart(view) {
          const transactionsList = await getTransactions();
          const expenses = transactionsList.filter(t => t.type === "expense");
      
          if (view === 'category') {
            // Regrouper les dépenses par catégorie
            const categories = [...new Set(expenses.map(t => t.category))];
            const amounts = categories.map(category => 
              expenses.filter(t => t.category === category).reduce((sum, t) => sum + t.amount, 0)
            );
      
            expenseChart.data.labels = categories;
            expenseChart.data.datasets[0].data = amounts;
          } else if (view === 'type') {
            // Regrouper les dépenses par type (revenu/dépense)
            const types = ['income', 'expense'];
            const amounts = types.map(type => 
              expenses.filter(t => t.type === type).reduce((sum, t) => sum + t.amount, 0)
            );
      
            expenseChart.data.labels = ['Revenu', 'Dépense'];
            expenseChart.data.datasets[0].data = amounts;
          }
      
          expenseChart.update();  // Actualiser le graphique
        }
      
        // Événements pour le formulaire
        document.getElementById("data-form").addEventListener("submit", e => {
          e.preventDefault();
      
          const category = document.getElementById("category").value;
          const type = document.getElementById("type").value;
          const amount = parseFloat(document.getElementById("amount").value);
      
          addTransaction(category, type, amount);  // Ajouter la transaction dans Firestore
      
          e.target.reset();
        });
      
        // Initialiser le tableau de bord au chargement
        updateDashboard();
      </script>
      
</body>
</html>
